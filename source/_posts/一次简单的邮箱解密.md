---
title: 一次简单的邮箱解密
date: 2021-12-16 17:43:01
tags: [js逆向, 逆向思路]
categories: 反爬
---

## 分析
### 查看请求相关信息
> 愉快的做着 Xpath 工程师，以及灵活的 Ctrl C、Ctrl V，突然就不灵了，一看响应邮箱地址被加密了。

1. 查看原始请求响应
> 发现邮箱的地方，提示开启 js，并且标签属性 data-spamprotect 的值像是待解密的数据
![img](https://gitee.com/PineKer/myfiles/raw/master/blog/20211216175532_1.png)

2. 查看 js 执行位置
> 根据以往的经验，应该是在某个地方获取 data-spamprotect 的属性值，然后解密，所以直接以它为关键字进行搜索，
> 除了一些静态文本，只有一个 js 文件出现了这个关键词，点进去
![img](https://gitee.com/PineKer/myfiles/raw/master/blog/20211216175532_2.png)

> 在这个位置下个端点，然后刷新页面，成功断住了，然后不停的单步调试，直到邮箱地址出现
![img](https://gitee.com/PineKer/myfiles/raw/master/blog/20211216175532_3.png)

> 经过 N 次 F11 后，邮箱地址终于出现了；
![img](https://gitee.com/PineKer/myfiles/raw/master/blog/20211216175532_4.png)

> 将调用堆栈跳到上一步，这个 o 函数执行前的状态，看一下参数
![img](https://gitee.com/PineKer/myfiles/raw/master/blog/20211216175532_5.png)

> 在控制台看看两个参数是啥，发现不知道是个啥，但是在上方找到了赋值的地方；简单分析后，都是根据`t.data("spamprotect")`计算得到的，
> 而这个值，就是待解密的响应标签中的属性值
![img](https://gitee.com/PineKer/myfiles/raw/master/blog/20211216175532_6.png)

> 将代码抠出整理，把动态获取密文，写死试试，发现能成功计算完成
![img](https://gitee.com/PineKer/myfiles/raw/master/blog/20211216175532_7.png)

### 本地调试 & `python`还原
1. 扣出代码，本地调试
> 直接把`function o()`的内容抠出，并去除不参与计算的部分；然后用 node 自带的 base64 方法手动去补充 atob 这样的函数；
![img](https://gitee.com/PineKer/myfiles/raw/master/blog/20211216175532_8.png)

2. python 还原
> 把 js 翻译一遍，需注意部分有注释
```python
’‘’
    python 执行
‘’‘
def data2email(data_spamprotect):  # o = function(e, t) {...
    import base64
    # atob(tobj.data("spamprotect"))
    data_spamprotect_decode = str(base64.b64decode(data_spamprotect.encode('utf8')), 'utf8')

    t = data_spamprotect_decode.split(":")[0]
    a = data_spamprotect_decode
    n = a.split(":")[0]

    def o(e, t):
        e = list(e) # e = e.split(""),   js 中 split(""),就是把每个字符都拆出来，对应 python 的其实是 list 函数
        t = list(t) # t = t.split("");
        for a in range(len(e)):
            # String.fromCharCode(str) 是将 ascii 编码转为一个字符，对应 python 中的 chr()
            # str.charCodeAt(0) 是将字符串中第一个字符，转为 ascii 码；对应 python 的 ord()
            e[a] = chr( ord(e[a][0]) ^ ord(t[a % len(t)][0]) )
        return "".join(e)

    emali = o(a.split(":")[1], n)
    return emali

data_spamprotect = "ODA1ODJhY2FmMGE3ZDNhYmQwMWY3MzljNDpKUVxWVxNNFQ5ZBFsBcwgEEx1aD1JfFwdR"
print( data2email(data_spamprotect) )

```



### 分析总结
> 没啥好总结的

## 代码验证
```js
//  node 中执行
window = globalThis
window.atob = function(b64Encoded){
    return Buffer.from(b64Encoded, 'base64').toString()
}
window.btoa = function(b64Encoded){
    return Buffer.from(b64Encoded).toString('base64')
}

data_spamprotect = "ODA1ODJhY2FmMGE3ZDNhYmQwMWY3MzljNDpKUVxWVxNNFQ5ZBFsBcwgEEx1aD1JfFwdR"
function SDK(data_spamprotect){
    var tobj = {}
    tobj.data = function(v){ return data_spamprotect}

    var e, 
        a = (e = tobj.data("spamprotect"),atob(e)), 
        n = a.split(":")[0], 
        o = function(e, t) {
            e = e.split(""),
            t = t.split("");
            for (var a = 0; a < e.length; a++)
                e[a] = String.fromCharCode(e[a].charCodeAt(0) ^ t[a % t.length].charCodeAt(0));
            return e.join("")
        }(a.split(":")[1], n);
    console.log(o)
    return o
}

console.log("SDK: ", SDK(data_spamprotect))
```